# 🧪 测试指南 - 静默刷新优化

**测试时间**: 2025年12月4日  
**测试内容**: 静默刷新 + 智能检测对手

---

## 🎯 测试目标

1. ✅ **无白屏闪烁** - 游戏界面刷新时不闪烁
2. ✅ **智能检测** - 大厅自动检测对手加入
3. ✅ **流畅体验** - 整体感觉流畅自然

---

## 🔧 测试环境

### 服务状态
```bash
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

**预期输出**:
```
NAMES            STATUS                    PORTS
weiqi-ai         Up (healthy)             0.0.0.0:8000->8000/tcp
weiqi-backend    Up                       0.0.0.0:8080->8080/tcp
weiqi-mongo      Up (healthy)             0.0.0.0:27017->27017/tcp
```

### 访问地址
- **前端**: http://localhost:3000
- **后端 API**: http://localhost:8080
- **AI 服务**: http://localhost:8000

---

## 📋 核心测试

### 测试 1: 游戏界面无白屏闪烁 ⭐⭐⭐

#### 准备
1. 打开两个浏览器窗口（或一个普通 + 一个无痕模式）
2. 分别登录两个不同的账号
3. 玩家 A 创建玩家对战
4. 玩家 B 加入游戏

#### 测试步骤
1. **玩家 A 落子**（黑棋）
2. **玩家 A 等待**，不要移动鼠标，盯着屏幕
3. **玩家 B 落子**（白棋）
4. **观察玩家 A 的屏幕**

#### 预期结果 ✅
```
玩家 B 落子后
↓
2 秒内玩家 A 看到白子出现
↓
关键：没有白屏闪烁！✨
↓
棋盘平滑更新
```

#### 检查点
- [ ] 2 秒内看到对方落子 ✅
- [ ] **没有白屏闪烁** ✅ ⭐
- [ ] 棋盘平滑更新 ✅
- [ ] 不干扰视线 ✅

#### 如果失败
- ❌ 如果看到白屏闪烁 → 检查是否使用了 `silentRefreshGame()`
- ❌ 如果超过 2 秒才看到 → 检查刷新间隔是否为 2000ms

---

### 测试 2: 大厅智能检测对手加入 ⭐⭐⭐

#### 准备
1. 打开两个浏览器窗口
2. 分别登录两个不同的账号

#### 测试步骤
1. **玩家 A**: 在大厅创建玩家对战
2. **玩家 A**: **停留在大厅**，不要进入游戏
3. **玩家 B**: 在大厅加入玩家 A 的游戏
4. **观察玩家 A 的大厅界面**

#### 预期结果 ✅
```
玩家 A 创建游戏
↓
游戏显示"等待中" 🟡
↓
玩家 B 加入游戏
↓
3 秒内游戏状态变为"进行中" 🟢
↓
关键：自动更新，无需手动刷新！✨
```

#### 检查点
- [ ] 3 秒内状态自动更新 ✅
- [ ] **无需手动刷新** ✅ ⭐
- [ ] 没有白屏闪烁 ✅
- [ ] 可以直接点击"进入游戏" ✅

#### 如果失败
- ❌ 如果没有自动更新 → 检查 `startAutoRefresh()` 是否调用
- ❌ 如果看到白屏闪烁 → 检查是否使用了 `silentRefreshAll()`

---

### 测试 3: 连续对弈流畅性 ⭐⭐

#### 测试步骤
1. 玩家 A 和玩家 B 快速交替落子
2. 每次落子后观察对方屏幕
3. 连续落子 10 次以上

#### 预期结果 ✅
```
玩家 A 落子 → 2秒 → 玩家 B 看到 ✅
玩家 B 落子 → 2秒 → 玩家 A 看到 ✅
玩家 A 落子 → 2秒 → 玩家 B 看到 ✅
...
```

#### 检查点
- [ ] 每次都能在 2 秒内看到 ✅
- [ ] 没有丢失落子 ✅
- [ ] 顺序正确 ✅
- [ ] **全程无白屏闪烁** ✅ ⭐

---

### 测试 4: 手动刷新按钮反馈 ⭐

#### 测试步骤
1. 在游戏界面
2. 点击"刷新"按钮
3. 观察按钮状态

#### 预期结果 ✅
```
点击"刷新"按钮
↓
按钮显示 loading 状态 ⏳
↓
数据刷新完成
↓
按钮恢复正常 ✅
```

#### 检查点
- [ ] 按钮显示 loading ✅
- [ ] 刷新完成后恢复 ✅
- [ ] 提供用户反馈 ✅

---

## 🎮 完整游戏流程测试

### 流程测试: 从创建到结束

#### 步骤
1. **玩家 A**: 在大厅创建玩家对战
2. **玩家 A**: 停留在大厅等待
3. **玩家 B**: 在大厅看到游戏并加入
4. **玩家 A**: 3 秒内看到游戏状态变为"进行中"
5. **玩家 A**: 点击"进入游戏"
6. **玩家 A**: 落子（黑棋）
7. **玩家 B**: 2 秒内看到黑子
8. **玩家 B**: 落子（白棋）
9. **玩家 A**: 2 秒内看到白子
10. 重复步骤 6-9 多次

#### 预期结果 ✅
- ✅ 每个步骤都流畅
- ✅ 全程无白屏闪烁
- ✅ 自动更新，无需手动刷新
- ✅ 体验自然流畅

---

## 🐛 问题排查

### 问题 1: 还是有白屏闪烁

**可能原因**:
1. 自动刷新使用了 `refreshGame()` 而不是 `silentRefreshGame()`
2. 浏览器缓存问题

**解决方法**:
```bash
# 1. 检查代码
grep "startAutoRefresh" weiqi-frontend/src/views/Game.vue -A 5

# 应该看到: silentRefreshGame()

# 2. 清除浏览器缓存
# 按 Ctrl+Shift+Delete，清除缓存

# 3. 重新构建
cd /home/zhuji/weiqi-go
docker compose up -d --build
```

---

### 问题 2: 大厅不自动刷新

**可能原因**:
1. `startAutoRefresh()` 没有在 `onMounted` 中调用
2. 定时器被意外清除

**解决方法**:
```bash
# 检查代码
grep "onMounted" weiqi-frontend/src/views/Lobby.vue -A 5

# 应该看到: startAutoRefresh()

# 检查浏览器控制台
# 打开 F12 → Console
# 看是否有错误信息
```

---

### 问题 3: 刷新太慢

**可能原因**:
1. 网络延迟
2. 服务器响应慢

**解决方法**:
```bash
# 1. 检查服务器状态
docker stats --no-stream

# 2. 检查网络延迟
curl -w "@-" -o /dev/null -s http://localhost:8080/v1/games/test <<'EOF'
time_total: %{time_total}s
EOF

# 3. 查看后端日志
docker logs weiqi-backend -f
```

---

### 问题 4: 定时器泄漏

**症状**: 
- 页面越来越慢
- CPU 使用率越来越高

**检查方法**:
```javascript
// 在浏览器控制台运行
console.log('Active timers:', window.setInterval.length)
```

**解决方法**:
- 确保 `onUnmounted` 中调用了 `stopAutoRefresh()`
- 重新加载页面

---

## 📊 性能测试

### 网络流量测试

#### 测试方法
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 开始一局游戏
4. 观察网络请求

#### 预期结果
```
游戏界面:
- 每 2 秒一次 GET /v1/games/{id}
- 请求大小: ~1-2KB
- 响应时间: < 100ms

大厅界面:
- 每 3 秒两次 GET 请求
- 请求大小: ~2-4KB
- 响应时间: < 100ms
```

#### 评估标准
- ✅ 请求频率合理
- ✅ 请求大小小
- ✅ 响应时间快
- ✅ 没有错误请求

---

### CPU 使用率测试

#### 测试方法
```bash
# 监控 Docker 容器
docker stats --no-stream

# 监控浏览器
# 打开 F12 → Performance → 录制 30 秒
```

#### 预期结果
```
weiqi-backend    CPU: < 5%
weiqi-ai         CPU: < 5%
weiqi-mongo      CPU: < 5%

浏览器 CPU:      < 10%
```

#### 评估标准
- ✅ CPU 使用率低
- ✅ 内存使用稳定
- ✅ 没有内存泄漏

---

## ✅ 测试检查清单

### 核心功能
- [ ] 游戏界面无白屏闪烁 ⭐
- [ ] 大厅自动检测对手加入 ⭐
- [ ] 2 秒内看到对方落子
- [ ] 3 秒内看到对手加入
- [ ] 手动刷新按钮有反馈

### 用户体验
- [ ] 整体感觉流畅
- [ ] 不干扰用户操作
- [ ] 自动更新无感知
- [ ] 没有卡顿

### 性能
- [ ] 网络请求频率合理
- [ ] CPU 使用率低
- [ ] 内存使用稳定
- [ ] 没有内存泄漏

### 边界情况
- [ ] 网络断开后恢复
- [ ] 切换标签页后恢复
- [ ] 长时间运行稳定
- [ ] 多个游戏同时进行

---

## 🎯 测试结论

### 成功标准
- ✅ **无白屏闪烁** - 最重要！
- ✅ 智能检测对手加入
- ✅ 准实时更新（2-3秒）
- ✅ 流畅的用户体验

### 如果测试失败
1. 检查代码是否使用 `silentRefresh` 函数
2. 清除浏览器缓存
3. 重新构建服务
4. 查看浏览器控制台错误
5. 查看 Docker 日志

---

## 🚀 快速测试命令

### 启动服务
```bash
cd /home/zhuji/weiqi-go
docker compose up -d --build
```

### 查看日志
```bash
# 查看后端日志
docker logs weiqi-backend -f

# 查看 AI 日志
docker logs weiqi-ai -f
```

### 检查服务状态
```bash
docker ps
docker stats --no-stream
```

### 测试 API
```bash
# 测试后端健康
curl http://localhost:8080/health

# 测试 AI 健康
curl http://localhost:8000/health
```

---

## 📝 测试报告模板

```markdown
## 静默刷新测试报告

**测试时间**: YYYY-MM-DD HH:MM
**测试人员**: [姓名]
**浏览器**: [Chrome/Firefox/Safari + 版本]

### 核心功能测试

#### 1. 无白屏闪烁
- 测试结果: [✅/❌]
- 说明: [描述]

#### 2. 智能检测对手
- 测试结果: [✅/❌]
- 说明: [描述]

#### 3. 刷新速度
- 游戏界面: [✅/❌] (预期 2 秒)
- 大厅界面: [✅/❌] (预期 3 秒)

### 性能测试

#### 网络流量
- 请求频率: [合理/过高]
- 请求大小: [正常/过大]
- 响应时间: [快/慢]

#### CPU 使用
- 后端: [%]
- 前端: [%]
- 评估: [正常/异常]

### 发现的问题
[列出发现的问题]

### 建议
[提出改进建议]

### 总体评价
[优秀/良好/需改进]
```

---

## 🎉 测试完成

完成所有测试后，确认：
- ✅ **无白屏闪烁** ⭐⭐⭐
- ✅ 智能检测对手加入
- ✅ 准实时更新
- ✅ 流畅的用户体验

**祝测试顺利！** 🎮✨

---

## 💡 测试技巧

### 技巧 1: 使用慢动作观察

```javascript
// 在浏览器控制台运行，减慢刷新速度以便观察
// 临时修改刷新间隔为 5 秒
window.testSlowRefresh = true
```

### 技巧 2: 记录刷新时间

```javascript
// 在浏览器控制台运行，记录每次刷新
let refreshCount = 0
const originalFetch = window.fetch
window.fetch = function(...args) {
  if (args[0].includes('/games/')) {
    console.log(`[${new Date().toISOString()}] Refresh #${++refreshCount}`)
  }
  return originalFetch.apply(this, args)
}
```

### 技巧 3: 检测白屏闪烁

```javascript
// 在浏览器控制台运行，检测 DOM 重渲染
const observer = new MutationObserver((mutations) => {
  console.log('DOM changed:', mutations.length, 'mutations')
})
observer.observe(document.body, { childList: true, subtree: true })
```

---

**测试愉快！** 🧪✨

