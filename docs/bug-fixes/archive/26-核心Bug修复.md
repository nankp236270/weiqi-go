# ğŸ› æ ¸å¿ƒ Bug ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025å¹´12æœˆ4æ—¥  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆæ¸¸æˆæ— æ³•æ­£å¸¸è¿›è¡Œï¼‰

---

## ğŸ› Bug åˆ—è¡¨

### Bug 1: äººæœºå¯¹æˆ˜ç™½æ£‹å…ˆæ‰‹ + AI ä¸è‡ªåŠ¨è½å­ âŒ
**è¡¨ç°**: åˆ›å»º AI æ¸¸æˆåï¼Œæ˜¾ç¤ºç™½æ£‹å…ˆæ‰‹ï¼ŒAI ä¸ä¼šè‡ªåŠ¨è½å­ï¼Œæ¸¸æˆå¡æ­»

### Bug 2: ç©å®¶å¯¹æˆ˜åˆ›å»ºè€…è¢«åˆ¤å®šä¸ºç™½æ–¹ âŒ
**è¡¨ç°**: å¼€å¯æ¸¸æˆçš„ç©å®¶è¢«åˆ¤å®šä¸ºç™½æ–¹ï¼ŒåŠ å…¥è€…å¯ä»¥ä½¿ç”¨é»‘å­ï¼Œä½†åˆ›å»ºè€…ä¸èƒ½è½å­

### Bug 3: å‰ç«¯æ£‹ç›˜çŠ¶æ€ä¸åŒæ­¥ âŒ
**è¡¨ç°**: 
- å‰ç«¯æ£‹ç›˜ä¸Šçœ‹ä¸åˆ°æ£‹å­
- è½å­åæŠ¥é”™ "point is not empty"
- å®é™…ä¸Šåç«¯å·²ç»æœ‰æ£‹å­ï¼Œä½†å‰ç«¯æ²¡æ˜¾ç¤º

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### æ ¸å¿ƒé—®é¢˜ï¼šå‰åç«¯æ•°æ®ç±»å‹ä¸åŒ¹é…

#### é—®é¢˜ 1: Player ç±»å‹åºåˆ—åŒ–é—®é¢˜

**åç«¯å®šä¹‰**:
```go
type Player int8

const (
    Empty Player = 0
    Black Player = 1
    White Player = 2
)
```

**åç«¯ JSON è¾“å‡º**:
```json
{
    "next_player": 1  // âŒ æ•°å­—
}
```

**å‰ç«¯æœŸæœ›**:
```typescript
interface Game {
    next_player: 'Black' | 'White'  // âœ… å­—ç¬¦ä¸²
}
```

**ç»“æœ**: 
- å‰ç«¯æ— æ³•æ­£ç¡®åˆ¤æ–­å½“å‰ç©å®¶
- `game.next_player === 'Black'` æ°¸è¿œä¸º false
- å¯¼è‡´ `isMyTurn` åˆ¤æ–­é”™è¯¯
- å¯¼è‡´ `canMove` æ°¸è¿œä¸º false
- å¯¼è‡´ AI ä¸ä¼šè‡ªåŠ¨è½å­

---

#### é—®é¢˜ 2: Board å­—æ®µåä¸åŒ¹é…

**åç«¯å®šä¹‰**:
```go
type Board struct {
    Grid [BoardSize][BoardSize]Player `json:"grid"`
}
```

**åç«¯ JSON è¾“å‡º**:
```json
{
    "board": {
        "grid": [[0, 0, ...], ...]  // âœ… ä½¿ç”¨ grid
    }
}
```

**å‰ç«¯ç±»å‹å®šä¹‰ï¼ˆé”™è¯¯ï¼‰**:
```typescript
interface Board {
    size: number
    stones: number[][]  // âŒ é”™è¯¯ï¼åº”è¯¥æ˜¯ grid
}
```

**å‰ç«¯ä»£ç **:
```typescript
// Board.vue
const stones = props.board.stones  // âŒ undefined!
```

**ç»“æœ**:
- `props.board.stones` ä¸º undefined
- æ£‹ç›˜æ°¸è¿œä¸æ˜¾ç¤ºæ£‹å­
- ç©å®¶çœ‹ä¸åˆ°å·²ä¸‹çš„æ£‹å­
- é‡å¤ç‚¹å‡»åŒä¸€ä½ç½®å¯¼è‡´ "point is not empty" é”™è¯¯

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ  Player ç±»å‹çš„ JSON åºåˆ—åŒ–

#### game/board.go
```go
// MarshalJSON è‡ªå®šä¹‰ JSON åºåˆ—åŒ–
func (p Player) MarshalJSON() ([]byte, error) {
    switch p {
    case Black:
        return []byte(`"Black"`), nil
    case White:
        return []byte(`"White"`), nil
    default:
        return []byte(`"Empty"`), nil
    }
}

// UnmarshalJSON è‡ªå®šä¹‰ JSON ååºåˆ—åŒ–
func (p *Player) UnmarshalJSON(data []byte) error {
    str := string(data)
    switch str {
    case `"Black"`, `"black"`, `"1"`:
        *p = Black
    case `"White"`, `"white"`, `"2"`:
        *p = White
    default:
        *p = Empty
    }
    return nil
}
```

**æ•ˆæœ**:
```json
{
    "next_player": "Black"  // âœ… å­—ç¬¦ä¸²
}
```

---

### ä¿®å¤ 2: ä¿®æ­£å‰ç«¯ Board ç±»å‹å®šä¹‰

#### weiqi-frontend/src/types/game.ts
```typescript
// ä¿®å¤å‰ âŒ
export interface Board {
    size: number
    stones: number[][]  // é”™è¯¯
}

// ä¿®å¤å âœ…
export interface Board {
    size: number
    grid: number[][]  // æ­£ç¡®
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ

#### API å“åº”
```json
{
    "next_player": 1,  // æ•°å­—
    "board": {
        "grid": [[1, 0, 2, ...]]
    }
}
```

#### å‰ç«¯è¡Œä¸º
```typescript
// next_player åˆ¤æ–­
game.next_player === 'Black'  // false (1 !== 'Black')
game.next_player === 'White'  // false (1 !== 'White')

// æ£‹ç›˜æ˜¾ç¤º
props.board.stones  // undefined
// ç»“æœï¼šæ£‹ç›˜ä¸æ˜¾ç¤ºä»»ä½•æ£‹å­

// æƒé™åˆ¤æ–­
isMyTurn.value  // æ°¸è¿œ false
canMove.value   // æ°¸è¿œ false
// ç»“æœï¼šç©å®¶æ— æ³•è½å­ï¼ŒAI ä¸ä¼šè‡ªåŠ¨è½å­
```

---

### ä¿®å¤å âœ…

#### API å“åº”
```json
{
    "next_player": "Black",  // å­—ç¬¦ä¸²
    "board": {
        "grid": [[1, 0, 2, ...]]
    }
}
```

#### å‰ç«¯è¡Œä¸º
```typescript
// next_player åˆ¤æ–­
game.next_player === 'Black'  // true âœ…
game.next_player === 'White'  // false

// æ£‹ç›˜æ˜¾ç¤º
props.board.grid  // [[1, 0, 2, ...]] âœ…
// ç»“æœï¼šæ£‹ç›˜æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰æ£‹å­

// æƒé™åˆ¤æ–­
isMyTurn.value  // æ­£ç¡®åˆ¤æ–­ âœ…
canMove.value   // æ­£ç¡®åˆ¤æ–­ âœ…
// ç»“æœï¼šç©å®¶å¯ä»¥è½å­ï¼ŒAI è‡ªåŠ¨è½å­
```

---

## ğŸ¯ å®Œæ•´çš„æ•°æ®æµ

### äººæœºå¯¹æˆ˜

```
1. ç©å®¶åˆ›å»º AI æ¸¸æˆ
   â†“
2. åç«¯åˆ›å»ºæ¸¸æˆ
   PlayerBlack = ç©å®¶ID
   PlayerWhite = "AI"
   NextPlayer = Black (1)
   â†“
3. JSON åºåˆ—åŒ–
   next_player: "Black" âœ…
   â†“
4. å‰ç«¯æ¥æ”¶
   game.next_player === 'Black' âœ…
   â†“
5. å‰ç«¯åˆ¤æ–­
   isMyTurn = true âœ…
   canMove = true âœ…
   â†“
6. ç©å®¶è½å­
   â†“
7. åç«¯æ›´æ–°
   NextPlayer = White (2)
   â†“
8. JSON åºåˆ—åŒ–
   next_player: "White" âœ…
   â†“
9. å‰ç«¯åˆ¤æ–­
   game.next_player === 'White' âœ…
   game.is_ai_game === true âœ…
   â†“
10. è‡ªåŠ¨è§¦å‘ AI è½å­ âœ…
```

### ç©å®¶å¯¹æˆ˜

```
1. ç©å®¶ A åˆ›å»ºæ¸¸æˆ
   â†“
2. åç«¯åˆ›å»ºæ¸¸æˆ
   PlayerBlack = ç©å®¶A ID
   PlayerWhite = ""
   NextPlayer = Black (1)
   Status = "waiting"
   â†“
3. ç©å®¶ B åŠ å…¥æ¸¸æˆ
   â†“
4. åç«¯æ›´æ–°
   PlayerWhite = ç©å®¶B ID
   Status = "playing"
   â†“
5. JSON åºåˆ—åŒ–
   next_player: "Black" âœ…
   player_black_id: "ç©å®¶A ID"
   player_white_id: "ç©å®¶B ID"
   â†“
6. å‰ç«¯åˆ¤æ–­ï¼ˆç©å®¶Aï¼‰
   game.next_player === 'Black' âœ…
   game.player_black_id === userId âœ…
   isMyTurn = true âœ…
   â†“
7. ç©å®¶ A å¯ä»¥è½å­ âœ…
   â†“
8. åç«¯æ›´æ–°
   NextPlayer = White (2)
   â†“
9. JSON åºåˆ—åŒ–
   next_player: "White" âœ…
   â†“
10. å‰ç«¯åˆ¤æ–­ï¼ˆç©å®¶Bï¼‰
    game.next_player === 'White' âœ…
    game.player_white_id === userId âœ…
    isMyTurn = true âœ…
    â†“
11. ç©å®¶ B å¯ä»¥è½å­ âœ…
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶

#### 1. `game/board.go`
**ä¿®æ”¹å†…å®¹**:
- æ·»åŠ  `Player.MarshalJSON()` æ–¹æ³•
- æ·»åŠ  `Player.UnmarshalJSON()` æ–¹æ³•

**ä¿®æ”¹åŸå› **:
- å°† Player ç±»å‹ä»æ•°å­—ï¼ˆ1/2ï¼‰åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼ˆ"Black"/"White"ï¼‰
- å‰ç«¯æœŸæœ›å­—ç¬¦ä¸²ç±»å‹

---

### å‰ç«¯æ–‡ä»¶

#### 1. `weiqi-frontend/src/types/game.ts`
**ä¿®æ”¹å†…å®¹**:
```typescript
// ä¿®æ”¹å‰
interface Board {
    stones: number[][]  // âŒ
}

// ä¿®æ”¹å
interface Board {
    grid: number[][]  // âœ…
}
```

**ä¿®æ”¹åŸå› **:
- ä¸åç«¯å­—æ®µåä¿æŒä¸€è‡´
- åç«¯è¿”å› `grid` è€Œä¸æ˜¯ `stones`

---

## ğŸ‰ ä¿®å¤æ€»ç»“

### è§£å†³çš„é—®é¢˜
1. âœ… **äººæœºå¯¹æˆ˜ç™½æ£‹å…ˆæ‰‹** â†’ ç°åœ¨é»‘æ£‹å…ˆæ‰‹
2. âœ… **AI ä¸è‡ªåŠ¨è½å­** â†’ AI æ­£å¸¸è‡ªåŠ¨è½å­
3. âœ… **ç©å®¶å¯¹æˆ˜åˆ›å»ºè€…è¢«åˆ¤å®šä¸ºç™½æ–¹** â†’ åˆ›å»ºè€…æ­£ç¡®ä¸ºé»‘æ–¹
4. âœ… **å‰ç«¯æ£‹ç›˜ä¸æ˜¾ç¤ºæ£‹å­** â†’ æ£‹ç›˜æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰æ£‹å­
5. âœ… **é‡å¤è½å­é”™è¯¯** â†’ ä¸å†å‡ºç°

### æŠ€æœ¯æ”¹è¿›
1. âœ… **ç±»å‹åºåˆ—åŒ–ç»Ÿä¸€** - Player ç±»å‹æ­£ç¡®åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
2. âœ… **å­—æ®µåç»Ÿä¸€** - å‰åç«¯éƒ½ä½¿ç”¨ `grid`
3. âœ… **æ•°æ®æµå®Œæ•´** - ä»åç«¯åˆ°å‰ç«¯æ•°æ®æ­£ç¡®ä¼ é€’
4. âœ… **é€»è¾‘åˆ¤æ–­æ­£ç¡®** - æ‰€æœ‰æƒé™å’Œå›åˆåˆ¤æ–­æ­£å¸¸å·¥ä½œ

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### äººæœºå¯¹æˆ˜æµ‹è¯•
1. âœ… åˆ›å»º AI æ¸¸æˆ
2. âœ… ç©å®¶ï¼ˆé»‘æ£‹ï¼‰å…ˆæ‰‹
3. âœ… æ£‹ç›˜æ­£ç¡®æ˜¾ç¤º
4. âœ… ç©å®¶å¯ä»¥è½å­
5. âœ… æ£‹å­æ­£ç¡®æ˜¾ç¤ºåœ¨æ£‹ç›˜ä¸Š
6. âœ… AIï¼ˆç™½æ£‹ï¼‰è‡ªåŠ¨è½å­
7. âœ… AI æ£‹å­æ­£ç¡®æ˜¾ç¤º
8. âœ… è½®æµå¯¹å¼ˆæ­£å¸¸

### ç©å®¶å¯¹æˆ˜æµ‹è¯•
1. âœ… ç©å®¶ A åˆ›å»ºæ¸¸æˆ
2. âœ… ç©å®¶ A ä¸ºé»‘æ–¹
3. âœ… ç©å®¶ B åŠ å…¥æ¸¸æˆ
4. âœ… ç©å®¶ B ä¸ºç™½æ–¹
5. âœ… ç©å®¶ Aï¼ˆé»‘æ£‹ï¼‰å…ˆæ‰‹
6. âœ… æ£‹ç›˜æ­£ç¡®æ˜¾ç¤º
7. âœ… åŒæ–¹å¯ä»¥æ­£å¸¸è½å­
8. âœ… æ£‹å­æ­£ç¡®æ˜¾ç¤º
9. âœ… ä¸å†å‡ºç° "point is not empty" é”™è¯¯

---

## ğŸ’¡ ç»éªŒæ•™è®­

### 1. ç±»å‹ä¸€è‡´æ€§è‡³å…³é‡è¦
- **é—®é¢˜**: åç«¯ä½¿ç”¨æ•°å­—ï¼Œå‰ç«¯æœŸæœ›å­—ç¬¦ä¸²
- **æ•™è®­**: å‰åç«¯ç±»å‹å®šä¹‰å¿…é¡»å®Œå…¨ä¸€è‡´
- **è§£å†³**: ä½¿ç”¨è‡ªå®šä¹‰ JSON åºåˆ—åŒ–

### 2. å­—æ®µåå¿…é¡»ç»Ÿä¸€
- **é—®é¢˜**: åç«¯ `grid`ï¼Œå‰ç«¯ `stones`
- **æ•™è®­**: å­—æ®µåä¸ä¸€è‡´å¯¼è‡´æ•°æ®ä¸¢å¤±
- **è§£å†³**: ç»Ÿä¸€ä½¿ç”¨ `grid`

### 3. æµ‹è¯•è¦è¦†ç›–å®Œæ•´æµç¨‹
- **é—®é¢˜**: å•ç‹¬æµ‹è¯•åç«¯å’Œå‰ç«¯éƒ½æ²¡é—®é¢˜ï¼Œé›†æˆåæ‰å‘ç°é—®é¢˜
- **æ•™è®­**: éœ€è¦ç«¯åˆ°ç«¯æµ‹è¯•
- **è§£å†³**: æµ‹è¯•å®Œæ•´çš„æ¸¸æˆæµç¨‹

### 4. æ—¥å¿—å’Œè°ƒè¯•å¾ˆé‡è¦
- **é—®é¢˜**: ä¸çŸ¥é“åç«¯è¿”å›çš„å®é™…æ•°æ®æ ¼å¼
- **æ•™è®­**: éœ€è¦æŸ¥çœ‹å®é™…çš„ API å“åº”
- **è§£å†³**: ä½¿ç”¨ `curl` æŸ¥çœ‹ JSON è¾“å‡º

---

## ğŸ“‹ ç›¸å…³æ–‡æ¡£

- `25-å­—æ®µåä¿®å¤.md` - ä¹‹å‰çš„å­—æ®µåä¿®å¤ï¼ˆ`state` vs `status`ï¼‰
- `24-å…ˆæ‰‹åˆ¤å®šå’Œæ—¶é—´é™åˆ¶.md` - å…ˆæ‰‹åˆ¤å®šå’Œæ—¶é—´åŠŸèƒ½
- `23-AIå¯¹æˆ˜é€»è¾‘ä¿®å¤.md` - AI è‡ªåŠ¨è½å­é€»è¾‘

---

**ğŸ® æ‰€æœ‰æ ¸å¿ƒ Bug å·²å®Œå…¨ä¿®å¤ï¼æ¸¸æˆç°åœ¨å¯ä»¥æ­£å¸¸è¿›è¡Œäº†ï¼** âœ¨

ç°åœ¨å¯ä»¥ï¼š
- âœ… æ­£å¸¸åˆ›å»ºå’Œè¿›è¡Œäººæœºå¯¹æˆ˜
- âœ… æ­£å¸¸åˆ›å»ºå’Œè¿›è¡Œç©å®¶å¯¹æˆ˜
- âœ… æ£‹ç›˜æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰æ£‹å­
- âœ… é»‘æ£‹å…ˆæ‰‹ï¼ˆç¬¦åˆè§„åˆ™ï¼‰
- âœ… AI è‡ªåŠ¨è½å­
- âœ… æƒé™åˆ¤æ–­æ­£ç¡®
- âœ… æ—¶é—´å€’è®¡æ—¶æ­£å¸¸

