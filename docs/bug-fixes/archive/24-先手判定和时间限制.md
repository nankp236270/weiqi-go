# âš«âšª å…ˆæ‰‹åˆ¤å®šå’Œæ—¶é—´é™åˆ¶åŠŸèƒ½å®ç°

**å®ç°æ—¶é—´**: 2025å¹´12æœˆ4æ—¥  
**åŠŸèƒ½**: é»‘æ£‹å…ˆæ‰‹åˆ¤å®š + æ¸¸æˆæ—¶é—´é™åˆ¶ + å®æ—¶å€’è®¡æ—¶

---

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. å…ˆæ‰‹åˆ¤å®š âœ…

#### é—®é¢˜æè¿°
- **ç°è±¡**: ç™½æ£‹å…ˆæ‰‹
- **åŸå› **: åç«¯ JSON å­—æ®µåä¸åŒ¹é…ï¼ˆ`player_black` vs `player_black_id`ï¼‰
- **é¢„æœŸ**: é»‘æ£‹å…ˆæ‰‹ï¼ˆç¬¦åˆå›´æ£‹è§„åˆ™ï¼‰

#### è§£å†³æ–¹æ¡ˆ

##### åç«¯ä¿®æ”¹
```go
// game/game.go
type Game struct {
    // ... å…¶ä»–å­—æ®µ
    PlayerBlack  string  `json:"player_black_id" bson:"player_black"`   // ä¿®æ”¹ JSON æ ‡ç­¾
    PlayerWhite  string  `json:"player_white_id" bson:"player_white"`   // ä¿®æ”¹ JSON æ ‡ç­¾
    // ... å…¶ä»–å­—æ®µ
}
```

##### å‰ç«¯ä¿®æ”¹
```typescript
// types/game.ts
export interface Game {
  // ... å…¶ä»–å­—æ®µ
  next_player: 'Black' | 'White'  // æ”¹ä¸ºå¤§å†™ï¼Œä¸åç«¯ä¸€è‡´
  player_black_id?: string
  player_white_id?: string
  is_ai_game: boolean
  // ... å…¶ä»–å­—æ®µ
}
```

#### ä¿®å¤æ•ˆæœ
- âœ… é»‘æ£‹å§‹ç»ˆå…ˆæ‰‹
- âœ… å‰åç«¯å­—æ®µåä¸€è‡´
- âœ… AI æ¸¸æˆä¸­ç©å®¶æ‰§é»‘ï¼ŒAI æ‰§ç™½
- âœ… ç©å®¶å¯¹æˆ˜ä¸­åˆ›å»ºè€…æ‰§é»‘ï¼ŒåŠ å…¥è€…æ‰§ç™½

---

### 2. æ¸¸æˆæ—¶é—´é™åˆ¶ âœ…

#### ä¸­å›½å›´æ£‹è§„åˆ™
- **æ¯æ–¹æ—¶é—´**: 1 å°æ—¶ï¼ˆ3600 ç§’ï¼‰
- **è®¡æ—¶æ–¹å¼**: è½å­ååˆ‡æ¢è®¡æ—¶
- **è¶…æ—¶åˆ¤å®š**: æ—¶é—´å½’é›¶åˆ™åˆ¤è´Ÿ

#### åç«¯å®ç°

##### 1. æ·»åŠ æ—¶é—´å­—æ®µ
```go
type Game struct {
    // ... å…¶ä»–å­—æ®µ
    BlackTimeLeft   int64  `json:"black_time_left" bson:"black_time_left"`    // é»‘æ£‹å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
    WhiteTimeLeft   int64  `json:"white_time_left" bson:"white_time_left"`    // ç™½æ£‹å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
    LastMoveTime    int64  `json:"last_move_time" bson:"last_move_time"`      // ä¸Šæ¬¡è½å­æ—¶é—´æˆ³
    TimePerPlayer   int64  `json:"time_per_player" bson:"time_per_player"`    // æ¯ä½ç©å®¶æ€»æ—¶é—´ï¼ˆç§’ï¼‰
}
```

##### 2. åˆå§‹åŒ–æ—¶é—´
```go
func NewGame() *Game {
    // ... å…¶ä»–åˆå§‹åŒ–
    const defaultTimePerPlayer = 3600  // 1 å°æ—¶
    
    return &Game{
        // ... å…¶ä»–å­—æ®µ
        BlackTimeLeft: defaultTimePerPlayer,
        WhiteTimeLeft: defaultTimePerPlayer,
        TimePerPlayer: defaultTimePerPlayer,
    }
}
```

##### 3. æ—¶é—´ç®¡ç†å‡½æ•°
```go
// è·å–å½“å‰æ—¶é—´æˆ³
func getCurrentTimestamp() int64 {
    return time.Now().Unix()
}

// æ›´æ–°ç©å®¶å‰©ä½™æ—¶é—´
func (g *Game) UpdateTime() error {
    if g.GameOver || g.Status != GameStatusPlaying {
        return nil
    }
    
    if g.LastMoveTime == 0 {
        g.LastMoveTime = getCurrentTimestamp()
        return nil
    }
    
    // è®¡ç®—ç»è¿‡çš„æ—¶é—´
    now := getCurrentTimestamp()
    elapsed := now - g.LastMoveTime
    
    // æ‰£é™¤å½“å‰ç©å®¶çš„æ—¶é—´
    if g.NextPlayer == Black {
        g.BlackTimeLeft -= elapsed
        if g.BlackTimeLeft <= 0 {
            g.BlackTimeLeft = 0
            g.GameOver = true
            return ErrTimeOut
        }
    } else {
        g.WhiteTimeLeft -= elapsed
        if g.WhiteTimeLeft <= 0 {
            g.WhiteTimeLeft = 0
            g.GameOver = true
            return ErrTimeOut
        }
    }
    
    g.LastMoveTime = now
    return nil
}
```

##### 4. è½å­æ—¶æ›´æ–°æ—¶é—´
```go
func (g *Game) PlayMove(p Point) error {
    if g.GameOver {
        return errors.New("game is over")
    }

    // 0. æ›´æ–°æ—¶é—´
    if err := g.UpdateTime(); err != nil {
        return err // è¶…æ—¶
    }
    
    // ... å…¶ä»–è½å­é€»è¾‘
}

func (g *Game) PassTurn() error {
    if g.GameOver {
        return errors.New("game is over")
    }

    // æ›´æ–°æ—¶é—´
    if err := g.UpdateTime(); err != nil {
        return err // è¶…æ—¶
    }
    
    // ... å…¶ä»–è™šæ‰‹é€»è¾‘
}
```

##### 5. æ¸¸æˆå¼€å§‹æ—¶è®°å½•æ—¶é—´
```go
// AI æ¸¸æˆç«‹å³å¼€å§‹
func NewGameWithPlayer(playerID string, isAIGame bool) *Game {
    g := NewGame()
    g.PlayerBlack = playerID
    g.IsAIGame = isAIGame
    
    if isAIGame {
        g.PlayerWhite = "AI"
        g.Status = GameStatusPlaying
        g.LastMoveTime = getCurrentTimestamp() // è®°å½•å¼€å§‹æ—¶é—´
    }
    
    return g
}

// ç©å®¶åŠ å…¥æ—¶å¼€å§‹
func (g *Game) JoinGame(playerID string) error {
    // ... éªŒè¯é€»è¾‘
    
    g.PlayerWhite = playerID
    g.Status = GameStatusPlaying
    g.LastMoveTime = getCurrentTimestamp() // è®°å½•å¼€å§‹æ—¶é—´
    return nil
}
```

---

### 3. å‰ç«¯å®æ—¶å€’è®¡æ—¶ âœ…

#### å‰ç«¯å®ç°

##### 1. æ·»åŠ ç±»å‹å®šä¹‰
```typescript
export interface Game {
  // ... å…¶ä»–å­—æ®µ
  black_time_left: number
  white_time_left: number
  last_move_time: number
  time_per_player: number
  // ... å…¶ä»–å­—æ®µ
}
```

##### 2. æ·»åŠ æœ¬åœ°å€’è®¡æ—¶çŠ¶æ€
```typescript
// æœ¬åœ°å€’è®¡æ—¶
const localBlackTime = ref(0)
const localWhiteTime = ref(0)
const countdownTimer = ref<number | null>(null)
```

##### 3. å¯åŠ¨å€’è®¡æ—¶
```typescript
// å¯åŠ¨å€’è®¡æ—¶
const startCountdown = () => {
  countdownTimer.value = window.setInterval(() => {
    if (!gameStore.currentGame || gameStore.currentGame.game_over) {
      return
    }
    
    // åªæœ‰æ¸¸æˆè¿›è¡Œä¸­æ‰å€’è®¡æ—¶
    if (gameStore.currentGame.status === 'playing') {
      if (gameStore.currentGame.next_player === 'Black') {
        if (localBlackTime.value > 0) {
          localBlackTime.value--
          if (localBlackTime.value === 0) {
            ElMessage.error('é»‘æ£‹è¶…æ—¶ï¼')
            refreshGame()
          }
        }
      } else {
        if (localWhiteTime.value > 0) {
          localWhiteTime.value--
          if (localWhiteTime.value === 0) {
            ElMessage.error('ç™½æ£‹è¶…æ—¶ï¼')
            refreshGame()
          }
        }
      }
    }
  }, 1000)
}

// åœæ­¢å€’è®¡æ—¶
const stopCountdown = () => {
  if (countdownTimer.value) {
    clearInterval(countdownTimer.value)
    countdownTimer.value = null
  }
}
```

##### 4. æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
```typescript
// æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’ -> MM:SSï¼‰
const formatTime = (seconds: number): string => {
  if (!seconds || seconds < 0) return '00:00'
  const mins = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}
```

##### 5. UI æ˜¾ç¤º
```vue
<template>
  <!-- é»‘æ£‹æ—¶é—´ -->
  <div class="player-time" :class="{ 'time-warning': localBlackTime < 60 }">
    â±ï¸ {{ formatTime(localBlackTime) }}
  </div>
  
  <!-- ç™½æ£‹æ—¶é—´ -->
  <div class="player-time" :class="{ 'time-warning': localWhiteTime < 60 }">
    â±ï¸ {{ formatTime(localWhiteTime) }}
  </div>
</template>

<style scoped>
.player-time {
  font-size: 14px;
  color: #606266;
  margin-top: 5px;
  font-weight: 600;
}

.player-time.time-warning {
  color: #f56c6c;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}
</style>
```

##### 6. ç”Ÿå‘½å‘¨æœŸç®¡ç†
```typescript
onMounted(async () => {
  await gameStore.fetchGame(gameId)
  
  // åˆå§‹åŒ–æœ¬åœ°å€’è®¡æ—¶
  if (gameStore.currentGame) {
    localBlackTime.value = gameStore.currentGame.black_time_left || 0
    localWhiteTime.value = gameStore.currentGame.white_time_left || 0
  }
  
  startAutoRefresh()
  startCountdown()  // å¯åŠ¨å€’è®¡æ—¶
})

onUnmounted(() => {
  stopAutoRefresh()
  stopCountdown()  // åœæ­¢å€’è®¡æ—¶
})
```

##### 7. è½å­åæ›´æ–°æ—¶é—´
```typescript
const handleMove = async (point: Point) => {
  await gameStore.playMove(gameId, point)
  
  // æ›´æ–°æœ¬åœ°æ—¶é—´
  if (gameStore.currentGame) {
    localBlackTime.value = gameStore.currentGame.black_time_left || 0
    localWhiteTime.value = gameStore.currentGame.white_time_left || 0
  }
  
  // ... å…¶ä»–é€»è¾‘
}
```

---

## ğŸ® å®Œæ•´çš„æ¸¸æˆæµç¨‹

### äººæœºå¯¹æˆ˜ï¼ˆAI æ¸¸æˆï¼‰

```
1. ç©å®¶åˆ›å»º AI æ¸¸æˆ
   â†“
2. ç©å®¶ = é»‘æ£‹ï¼ˆå…ˆæ‰‹ï¼‰âœ…
   AI = ç™½æ£‹ï¼ˆåæ‰‹ï¼‰âœ…
   â†“
3. æ¸¸æˆå¼€å§‹ï¼Œè®¡æ—¶å¼€å§‹ â±ï¸
   é»‘æ£‹: 60:00
   ç™½æ£‹: 60:00
   â†“
4. ç©å®¶ï¼ˆé»‘æ£‹ï¼‰è½å­
   â†“
5. é»‘æ£‹æ—¶é—´æ‰£é™¤ â±ï¸
   â†“
6. AIï¼ˆç™½æ£‹ï¼‰è‡ªåŠ¨è½å­
   â†“
7. ç™½æ£‹æ—¶é—´æ‰£é™¤ â±ï¸
   â†“
8. é‡å¤ 4-7ï¼Œç›´åˆ°ï¼š
   - åŒæ–¹è¿ç»­è™šæ‰‹
   - ç©å®¶è®¤è¾“
   - ä»»ä¸€æ–¹è¶…æ—¶ â°
```

### ç©å®¶å¯¹æˆ˜

```
1. ç©å®¶ A åˆ›å»ºæ¸¸æˆ
   â†“
2. ç©å®¶ A = é»‘æ£‹ï¼ˆå…ˆæ‰‹ï¼‰âœ…
   â†“
3. ç©å®¶ B åŠ å…¥æ¸¸æˆ
   â†“
4. ç©å®¶ B = ç™½æ£‹ï¼ˆåæ‰‹ï¼‰âœ…
   â†“
5. æ¸¸æˆå¼€å§‹ï¼Œè®¡æ—¶å¼€å§‹ â±ï¸
   é»‘æ£‹: 60:00
   ç™½æ£‹: 60:00
   â†“
6. ç©å®¶ Aï¼ˆé»‘æ£‹ï¼‰è½å­
   â†“
7. é»‘æ£‹æ—¶é—´æ‰£é™¤ â±ï¸
   â†“
8. ç©å®¶ Bï¼ˆç™½æ£‹ï¼‰è½å­
   â†“
9. ç™½æ£‹æ—¶é—´æ‰£é™¤ â±ï¸
   â†“
10. é‡å¤ 6-9ï¼Œç›´åˆ°ï¼š
    - åŒæ–¹è¿ç»­è™šæ‰‹
    - ä»»ä¸€æ–¹è¶…æ—¶ â°
```

---

## ğŸ“Š æ—¶é—´ç®¡ç†ç»†èŠ‚

### åç«¯æ—¶é—´ç®¡ç†
1. **æ¸¸æˆåˆ›å»º**: åˆå§‹åŒ–åŒæ–¹æ—¶é—´ä¸º 3600 ç§’
2. **æ¸¸æˆå¼€å§‹**: è®°å½• `LastMoveTime`
3. **æ¯æ¬¡è½å­**: 
   - è®¡ç®— `elapsed = now - LastMoveTime`
   - æ‰£é™¤å½“å‰ç©å®¶æ—¶é—´
   - æ›´æ–° `LastMoveTime = now`
4. **è¶…æ—¶åˆ¤å®š**: 
   - æ—¶é—´ â‰¤ 0 æ—¶è®¾ç½® `GameOver = true`
   - è¿”å› `ErrTimeOut`

### å‰ç«¯å€’è®¡æ—¶
1. **åˆå§‹åŒ–**: ä»åç«¯è·å– `black_time_left` å’Œ `white_time_left`
2. **æœ¬åœ°å€’è®¡æ—¶**: æ¯ç§’å‡ 1
3. **åŒæ­¥**: æ¯æ¬¡è½å­åä»åç«¯åŒæ­¥æ—¶é—´
4. **è­¦å‘Š**: å‰©ä½™æ—¶é—´ < 60 ç§’æ—¶çº¢è‰²é—ªçƒ
5. **è¶…æ—¶**: æœ¬åœ°æ£€æµ‹åˆ° 0 æ—¶æç¤ºå¹¶åˆ·æ–°

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. å…ˆæ‰‹åˆ¤å®š
- âœ… ä¿®å¤å­—æ®µåä¸åŒ¹é…é—®é¢˜
- âœ… ç¡®ä¿é»‘æ£‹å§‹ç»ˆå…ˆæ‰‹
- âœ… å‰åç«¯ç±»å‹ä¸€è‡´

### 2. æ—¶é—´é™åˆ¶
- âœ… ç¬¦åˆä¸­å›½å›´æ£‹è§„åˆ™ï¼ˆæ¯æ–¹ 1 å°æ—¶ï¼‰
- âœ… åç«¯ç²¾ç¡®è®¡æ—¶
- âœ… å‰ç«¯å®æ—¶å€’è®¡æ—¶
- âœ… è¶…æ—¶è‡ªåŠ¨åˆ¤è´Ÿ

### 3. ç”¨æˆ·ä½“éªŒ
- âœ… å®æ—¶å€’è®¡æ—¶æ˜¾ç¤º
- âœ… å‰©ä½™æ—¶é—´ < 1 åˆ†é’Ÿæ—¶çº¢è‰²é—ªçƒ
- âœ… è¶…æ—¶æç¤º
- âœ… æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆMM:SSï¼‰

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶

#### 1. `game/game.go`
- æ·»åŠ æ—¶é—´ç›¸å…³å­—æ®µ
- ä¿®æ”¹ JSON æ ‡ç­¾ï¼ˆ`player_black_id`, `player_white_id`ï¼‰
- æ·»åŠ  `UpdateTime()` æ–¹æ³•
- æ·»åŠ  `getCurrentTimestamp()` å‡½æ•°
- ä¿®æ”¹ `PlayMove()` å’Œ `PassTurn()` è°ƒç”¨ `UpdateTime()`
- ä¿®æ”¹ `NewGameWithPlayer()` å’Œ `JoinGame()` è®°å½•å¼€å§‹æ—¶é—´

### å‰ç«¯æ–‡ä»¶

#### 1. `weiqi-frontend/src/types/game.ts`
- ä¿®æ”¹ `next_player` ç±»å‹ä¸º `'Black' | 'White'`
- æ·»åŠ  `is_ai_game` å­—æ®µ
- æ·»åŠ æ—¶é—´ç›¸å…³å­—æ®µ

#### 2. `weiqi-frontend/src/views/Game.vue`
- æ·»åŠ æœ¬åœ°å€’è®¡æ—¶çŠ¶æ€
- æ·»åŠ  `formatTime()` å‡½æ•°
- æ·»åŠ  `startCountdown()` å’Œ `stopCountdown()` å‡½æ•°
- ä¿®æ”¹ `onMounted()` å’Œ `onUnmounted()` ç”Ÿå‘½å‘¨æœŸ
- ä¿®æ”¹ `handleMove()` å’Œ `refreshGame()` æ›´æ–°æœ¬åœ°æ—¶é—´
- æ·»åŠ æ—¶é—´æ˜¾ç¤º UI
- æ·»åŠ æ—¶é—´è­¦å‘Šæ ·å¼

---

## âœ… æµ‹è¯•éªŒè¯

### å…ˆæ‰‹åˆ¤å®šæµ‹è¯•
1. âœ… åˆ›å»º AI æ¸¸æˆ â†’ ç©å®¶æ‰§é»‘ï¼ˆå…ˆæ‰‹ï¼‰
2. âœ… åˆ›å»ºç©å®¶å¯¹æˆ˜ â†’ åˆ›å»ºè€…æ‰§é»‘ï¼ˆå…ˆæ‰‹ï¼‰
3. âœ… åŠ å…¥æ¸¸æˆ â†’ åŠ å…¥è€…æ‰§ç™½ï¼ˆåæ‰‹ï¼‰

### æ—¶é—´é™åˆ¶æµ‹è¯•
1. âœ… æ¸¸æˆå¼€å§‹æ—¶æ˜¾ç¤º 60:00
2. âœ… è½å­åæ—¶é—´æ­£ç¡®æ‰£é™¤
3. âœ… å€’è®¡æ—¶æ¯ç§’æ›´æ–°
4. âœ… å‰©ä½™æ—¶é—´ < 1 åˆ†é’Ÿæ—¶çº¢è‰²é—ªçƒ
5. âœ… è¶…æ—¶åæ¸¸æˆç»“æŸ

---

## ğŸ‰ åŠŸèƒ½æ€»ç»“

### å·²å®ç°
- âœ… é»‘æ£‹å…ˆæ‰‹åˆ¤å®š
- âœ… å­—æ®µåç»Ÿä¸€
- âœ… æ¸¸æˆæ—¶é—´é™åˆ¶ï¼ˆæ¯æ–¹ 1 å°æ—¶ï¼‰
- âœ… åç«¯ç²¾ç¡®è®¡æ—¶
- âœ… å‰ç«¯å®æ—¶å€’è®¡æ—¶
- âœ… è¶…æ—¶åˆ¤å®š
- âœ… æ—¶é—´è­¦å‘Šæç¤º

### æŠ€æœ¯äº®ç‚¹
- âœ… å‰åç«¯ç±»å‹ä¸€è‡´
- âœ… ç²¾ç¡®çš„æ—¶é—´ç®¡ç†
- âœ… æµç•…çš„å€’è®¡æ—¶åŠ¨ç”»
- âœ… ç¬¦åˆä¸­å›½å›´æ£‹è§„åˆ™

---

## ğŸ“‹ å¾…å®ç°åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### é«˜çº§æ—¶é—´æ§åˆ¶
- [ ] è¯»ç§’åŠŸèƒ½ï¼ˆæœ€å 1 åˆ†é’Ÿæ¯æ­¥ 30 ç§’ï¼‰
- [ ] åŠ æ—¶åŠŸèƒ½ï¼ˆFischer æ—¶é—´ï¼‰
- [ ] è‡ªå®šä¹‰æ—¶é—´è®¾ç½®

### æ¸¸æˆå†å²
- [ ] è®°å½•æ¯æ­¥ç”¨æ—¶
- [ ] æ˜¾ç¤ºç”¨æ—¶ç»Ÿè®¡
- [ ] æ—¶é—´åˆ†æå›¾è¡¨

---

**ğŸ® å…ˆæ‰‹åˆ¤å®šå’Œæ—¶é—´é™åˆ¶åŠŸèƒ½å·²å®Œå…¨å®ç°ï¼** âœ¨

ç°åœ¨å¯ä»¥äº«å—å®Œæ•´çš„å›´æ£‹å¯¹å¼ˆä½“éªŒï¼š
- âœ… é»‘æ£‹å…ˆæ‰‹ï¼ˆç¬¦åˆè§„åˆ™ï¼‰
- âœ… æ¯æ–¹ 1 å°æ—¶ï¼ˆä¸­å›½è§„åˆ™ï¼‰
- âœ… å®æ—¶å€’è®¡æ—¶æ˜¾ç¤º
- âœ… è¶…æ—¶è‡ªåŠ¨åˆ¤è´Ÿ

