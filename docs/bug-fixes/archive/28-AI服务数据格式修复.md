# ğŸ¤– AI æœåŠ¡æ•°æ®æ ¼å¼ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025å¹´12æœˆ4æ—¥  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆAI å¯¹æˆ˜å®Œå…¨æ— æ³•è¿›è¡Œï¼‰

---

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ
1. **ç©å®¶è½å­åï¼Œå‰ç«¯æ²¡æœ‰æ˜¾ç¤ºç©å®¶çš„æ£‹å­**
2. **AI è½äº†ç©å®¶çš„é»‘å­**ï¼ˆAI åº”è¯¥è½ç™½å­ï¼‰
3. **å¤§é‡é”™è¯¯ä¿¡æ¯**ï¼š
```
AI service error: AI service returned error: 
{"detail":[
  {"type":"int_parsing","loc":["body","board",0,0],
   "msg":"Input should be a valid integer, unable to parse string as an integer",
   "input":"Empty"},
  {"type":"int_parsing","loc":["body","board",0,1],
   "msg":"Input should be a valid integer, unable to parse string as an integer",
   "input":"Empty"},
  ...
]}
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜é“¾æ¡

#### 1. AI å®¢æˆ·ç«¯å‘é€é”™è¯¯çš„æ•°æ®æ ¼å¼

**ai/client.go**:
```go
type MoveRequest struct {
    Board      [game.BoardSize][game.BoardSize]game.Player `json:"board"`
    NextPlayer game.Player                                 `json:"next_player"`
    History    []string                                    `json:"history"`
}

func (c *Client) GetMove(g *game.Game) (game.Point, error) {
    reqBody := MoveRequest{
        Board:      g.Board.Grid,  // â† Player ç±»å‹ä¼šè¢«åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼
        NextPlayer: g.NextPlayer,  // â† Player ç±»å‹ä¼šè¢«åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼
        History:    history,
    }
    // ...
}
```

#### 2. å‘é€ç»™ AI æœåŠ¡çš„æ•°æ®
```json
{
    "board": [
        ["Empty", "Empty", "Black", "White", ...],  // â† å­—ç¬¦ä¸²ï¼
        ["Empty", "Empty", "Empty", "Empty", ...],
        ...
    ],
    "next_player": "Black",  // â† å­—ç¬¦ä¸²ï¼
    "history": [...]
}
```

#### 3. AI æœåŠ¡æœŸæœ›çš„æ•°æ®
```python
# weiqi-ai/api/main.py
class MoveRequest(BaseModel):
    board: List[List[int]]  # â† æœŸæœ›æ•´æ•°ï¼
    next_player: int        # â† æœŸæœ›æ•´æ•°ï¼
    history: List[str]
```

#### 4. FastAPI éªŒè¯å¤±è´¥
```
Input should be a valid integer, unable to parse string as an integer
input: "Empty"
```

**ç»“æœ**: 
- AI æœåŠ¡æ— æ³•å¤„ç†è¯·æ±‚
- è¿”å› 422 Unprocessable Entity
- AI å¯¹æˆ˜å®Œå…¨æ— æ³•è¿›è¡Œ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹ AI å®¢æˆ·ç«¯ï¼Œæ‰‹åŠ¨è½¬æ¢ä¸ºæ•°å­—

#### 1. ä¿®æ”¹è¯·æ±‚ç±»å‹å®šä¹‰

**ä¿®æ”¹å‰** âŒ:
```go
type MoveRequest struct {
    Board      [game.BoardSize][game.BoardSize]game.Player `json:"board"`
    NextPlayer game.Player                                 `json:"next_player"`
    History    []string                                    `json:"history"`
}
```

**ä¿®æ”¹å** âœ…:
```go
type MoveRequest struct {
    Board      [][]int8 `json:"board"`  // ä½¿ç”¨æ•°å­—æ•°ç»„
    NextPlayer int8     `json:"next_player"`  // ä½¿ç”¨æ•°å­—
    History    []string `json:"history"`
}
```

---

#### 2. ä¿®æ”¹ GetMove å‡½æ•°

**ä¿®æ”¹å‰** âŒ:
```go
func (c *Client) GetMove(g *game.Game) (game.Point, error) {
    reqBody := MoveRequest{
        Board:      g.Board.Grid,  // Player ç±»å‹
        NextPlayer: g.NextPlayer,  // Player ç±»å‹
        History:    history,
    }
    // ...
}
```

**ä¿®æ”¹å** âœ…:
```go
func (c *Client) GetMove(g *game.Game) (game.Point, error) {
    // è½¬æ¢æ£‹ç›˜ä¸ºæ•°å­—æ•°ç»„
    board := make([][]int8, game.BoardSize)
    for i := 0; i < game.BoardSize; i++ {
        board[i] = make([]int8, game.BoardSize)
        for j := 0; j < game.BoardSize; j++ {
            board[i][j] = int8(g.Board.Grid[i][j])  // Player â†’ int8
        }
    }

    reqBody := MoveRequest{
        Board:      board,                  // int8 æ•°ç»„
        NextPlayer: int8(g.NextPlayer),     // int8
        History:    history,
    }
    // ...
}
```

---

#### 3. ä¿®æ”¹ ScoreRequest ç±»å‹

**ä¿®æ”¹å‰** âŒ:
```go
type ScoreRequest struct {
    Board [game.BoardSize][game.BoardSize]game.Player `json:"board"`
}
```

**ä¿®æ”¹å** âœ…:
```go
type ScoreRequest struct {
    Board [][]int8 `json:"board"`
}
```

---

#### 4. ä¿®æ”¹ CalculateScore å‡½æ•°

**ä¿®æ”¹å** âœ…:
```go
func (c *Client) CalculateScore(g *game.Game) (game.ScoreResult, error) {
    // è½¬æ¢æ£‹ç›˜ä¸ºæ•°å­—æ•°ç»„
    board := make([][]int8, game.BoardSize)
    for i := 0; i < game.BoardSize; i++ {
        board[i] = make([]int8, game.BoardSize)
        for j := 0; j < game.BoardSize; j++ {
            board[i][j] = int8(g.Board.Grid[i][j])
        }
    }

    reqBody := ScoreRequest{
        Board: board,
    }
    // ...
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ

#### å‘é€ç»™ AI çš„æ•°æ®
```json
{
    "board": [
        ["Empty", "Empty", "Black", ...],
        ["Empty", "Empty", "Empty", ...],
        ...
    ],
    "next_player": "Black",
    "history": []
}
```

#### AI æœåŠ¡å“åº”
```json
{
    "detail": [
        {
            "type": "int_parsing",
            "loc": ["body", "board", 0, 0],
            "msg": "Input should be a valid integer, unable to parse string as an integer",
            "input": "Empty"
        },
        ...
    ]
}
```

#### ç»“æœ
- âŒ AI æœåŠ¡æ— æ³•å¤„ç†
- âŒ è¿”å› 422 é”™è¯¯
- âŒ AI å¯¹æˆ˜æ— æ³•è¿›è¡Œ

---

### ä¿®å¤å âœ…

#### å‘é€ç»™ AI çš„æ•°æ®
```json
{
    "board": [
        [0, 0, 1, 2, 0, ...],
        [0, 0, 0, 0, 0, ...],
        ...
    ],
    "next_player": 1,
    "history": []
}
```

#### AI æœåŠ¡å“åº”
```json
{
    "x": 3,
    "y": 3,
    "confidence": 0.95
}
```

#### ç»“æœ
- âœ… AI æœåŠ¡æ­£å¸¸å¤„ç†
- âœ… è¿”å›æœ‰æ•ˆè½å­
- âœ… AI å¯¹æˆ˜æ­£å¸¸è¿›è¡Œ

---

## ğŸ¯ æ•°æ®æ ¼å¼æ€»ç»“

### ä¸åŒåœºæ™¯çš„æ•°æ®æ ¼å¼

| åœºæ™¯ | Player ç±»å‹ | JSON æ ¼å¼ | è¯´æ˜ |
|------|------------|----------|------|
| **API å“åº”ï¼ˆç»™å‰ç«¯ï¼‰** | | | |
| `next_player` | `Player` | `"Black"` / `"White"` | å­—ç¬¦ä¸²ï¼Œä¾¿äºå‰ç«¯åˆ¤æ–­ |
| `board.grid[i][j]` | `Player` | `0` / `1` / `2` | æ•°å­—ï¼Œæ€§èƒ½å¥½ |
| **AI æœåŠ¡è¯·æ±‚** | | | |
| `next_player` | `Player` | `1` / `2` | æ•°å­—ï¼ŒAI æœåŠ¡æœŸæœ› |
| `board[i][j]` | `Player` | `0` / `1` / `2` | æ•°å­—ï¼ŒAI æœåŠ¡æœŸæœ› |

### ä¸ºä»€ä¹ˆä¸åŒï¼Ÿ

#### API å“åº”ç»™å‰ç«¯
```typescript
// next_player ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œä¾¿äºåˆ¤æ–­
if (game.next_player === 'Black') {
    // é»‘æ£‹å›åˆ
}

// grid ä½¿ç”¨æ•°å­—ï¼Œæ€§èƒ½å¥½
if (stone === 0) continue  // ç©ºä½
if (stone === 1) drawBlack()  // é»‘å­
```

#### AI æœåŠ¡è¯·æ±‚
```python
# Python AI æœåŠ¡æœŸæœ›æ•°å­—
class MoveRequest(BaseModel):
    board: List[List[int]]  # æ•´æ•°æ•°ç»„
    next_player: int        # æ•´æ•°
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### ai/client.go

#### ä¿®æ”¹å†…å®¹
1. **MoveRequest** ç±»å‹ï¼š`Player` â†’ `int8`
2. **ScoreRequest** ç±»å‹ï¼š`Player` â†’ `int8`
3. **GetMove** å‡½æ•°ï¼šæ‰‹åŠ¨è½¬æ¢ `Board.Grid` ä¸º `int8` æ•°ç»„
4. **CalculateScore** å‡½æ•°ï¼šæ‰‹åŠ¨è½¬æ¢ `Board.Grid` ä¸º `int8` æ•°ç»„

#### ä¿®æ”¹åŸå› 
- AI æœåŠ¡æœŸæœ›æ•°å­—æ ¼å¼
- Player ç±»å‹ä¼šè¢«åºåˆ—åŒ–æˆå­—ç¬¦ä¸²
- éœ€è¦æ‰‹åŠ¨è½¬æ¢ä¸ºæ•°å­—

---

## ğŸ”„ å®Œæ•´çš„ AI å¯¹æˆ˜æµç¨‹

### 1. ç©å®¶åˆ›å»º AI æ¸¸æˆ
```
åç«¯: PlayerBlack = ç©å®¶ID, PlayerWhite = "AI"
å‰ç«¯: æ˜¾ç¤ºç©ºæ£‹ç›˜ï¼Œç­‰å¾…ç©å®¶è½å­
```

### 2. ç©å®¶ï¼ˆé»‘æ£‹ï¼‰è½å­
```
å‰ç«¯ â†’ åç«¯: POST /v1/games/{id}/move
åç«¯: æ›´æ–°æ£‹ç›˜ï¼ŒNextPlayer = White
åç«¯ â†’ å‰ç«¯: è¿”å›æ›´æ–°åçš„æ¸¸æˆçŠ¶æ€
å‰ç«¯: æ˜¾ç¤ºç©å®¶çš„é»‘å­
```

### 3. å‰ç«¯æ£€æµ‹åˆ°è½®åˆ° AI
```typescript
if (game.is_ai_game && game.next_player === 'White') {
    setTimeout(() => handleAIMove(), 800)
}
```

### 4. å‰ç«¯è°ƒç”¨ AI è½å­æ¥å£
```
å‰ç«¯ â†’ åç«¯: POST /v1/games/{id}/ai-move
```

### 5. åç«¯è°ƒç”¨ AI æœåŠ¡
```go
// ai/client.go
board := make([][]int8, 19)
for i := 0; i < 19; i++ {
    for j := 0; j < 19; j++ {
        board[i][j] = int8(g.Board.Grid[i][j])  // âœ… è½¬æ¢ä¸ºæ•°å­—
    }
}

reqBody := MoveRequest{
    Board:      board,                // âœ… æ•°å­—æ•°ç»„
    NextPlayer: int8(g.NextPlayer),   // âœ… æ•°å­—
    History:    history,
}
```

### 6. AI æœåŠ¡å¤„ç†è¯·æ±‚
```python
# weiqi-ai/api/main.py
@app.post("/v1/ai/move")
async def get_ai_move(request: MoveRequest):
    # request.board æ˜¯æ•´æ•°æ•°ç»„ âœ…
    # request.next_player æ˜¯æ•´æ•° âœ…
    move = get_random_legal_move(request.board, request.next_player)
    return {"x": move[0], "y": move[1], "confidence": 0.95}
```

### 7. åç«¯æ›´æ–°æ¸¸æˆçŠ¶æ€
```
åç«¯: æ‰§è¡Œ AI è½å­ï¼ŒNextPlayer = Black
åç«¯ â†’ å‰ç«¯: è¿”å›æ›´æ–°åçš„æ¸¸æˆçŠ¶æ€
```

### 8. å‰ç«¯æ˜¾ç¤º AI çš„æ£‹å­
```
å‰ç«¯: æ˜¾ç¤º AI çš„ç™½å­
å‰ç«¯: ç­‰å¾…ç©å®¶è½å­
```

---

## âœ… æµ‹è¯•éªŒè¯

### AI å¯¹æˆ˜æµ‹è¯•
1. âœ… åˆ›å»º AI æ¸¸æˆ
2. âœ… ç©å®¶ï¼ˆé»‘æ£‹ï¼‰è½å­
3. âœ… ç©å®¶çš„é»‘å­æ­£ç¡®æ˜¾ç¤º
4. âœ… AIï¼ˆç™½æ£‹ï¼‰è‡ªåŠ¨è½å­
5. âœ… AI çš„ç™½å­æ­£ç¡®æ˜¾ç¤º
6. âœ… ä¸å†å‡ºç° "int_parsing" é”™è¯¯
7. âœ… AI å¯¹æˆ˜æ­£å¸¸è¿›è¡Œ

### æ•°æ®æ ¼å¼éªŒè¯
```bash
# æŸ¥çœ‹å‘é€ç»™ AI çš„æ•°æ®ï¼ˆé€šè¿‡æ—¥å¿—ï¼‰
# board: [[0, 0, 1, ...]] âœ… æ•°å­—
# next_player: 1 âœ… æ•°å­—
```

---

## ğŸ’¡ æŠ€æœ¯æ€»ç»“

### å…³é”®ç‚¹
1. **ç±»å‹è½¬æ¢** - Player â†’ int8 â†’ JSON æ•°å­—
2. **æ‰‹åŠ¨åºåˆ—åŒ–** - ä¸ä¾èµ–é»˜è®¤çš„ JSON åºåˆ—åŒ–
3. **æ¥å£é€‚é…** - é€‚é… AI æœåŠ¡çš„æ•°æ®æ ¼å¼è¦æ±‚
4. **æ•°æ®ä¸€è‡´æ€§** - ç¡®ä¿å‘é€çš„æ•°æ®ç¬¦åˆ AI æœåŠ¡æœŸæœ›

### ç»éªŒæ•™è®­
1. âœ… ä¸åŒæœåŠ¡å¯èƒ½æœŸæœ›ä¸åŒçš„æ•°æ®æ ¼å¼
2. âœ… è‡ªå®šä¹‰åºåˆ—åŒ–å¯èƒ½å½±å“å…¶ä»–åœ°æ–¹
3. âœ… éœ€è¦ä¸ºä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„åºåˆ—åŒ–æ–¹å¼
4. âœ… æ‰‹åŠ¨è½¬æ¢æ•°æ®æ›´å¯æ§

---

## ğŸ‰ ä¿®å¤æ€»ç»“

### è§£å†³çš„é—®é¢˜
- âœ… **AI æœåŠ¡ int_parsing é”™è¯¯** â†’ ç°åœ¨å‘é€æ•°å­—æ ¼å¼
- âœ… **AI å¯¹æˆ˜æ— æ³•è¿›è¡Œ** â†’ ç°åœ¨æ­£å¸¸å·¥ä½œ
- âœ… **ç©å®¶è½å­ä¸æ˜¾ç¤º** â†’ ç°åœ¨æ­£ç¡®æ˜¾ç¤º
- âœ… **AI è½é”™æ£‹å­** â†’ ç°åœ¨æ­£ç¡®è½ç™½å­

### æŠ€æœ¯æ”¹è¿›
- âœ… **AI å®¢æˆ·ç«¯æ•°æ®è½¬æ¢** - æ‰‹åŠ¨è½¬æ¢ä¸ºæ•°å­—
- âœ… **ç±»å‹å®šä¹‰ä¼˜åŒ–** - ä½¿ç”¨ int8 è€Œä¸æ˜¯ Player
- âœ… **æ¥å£é€‚é…** - ç¬¦åˆ AI æœåŠ¡è¦æ±‚
- âœ… **é”™è¯¯å¤„ç†** - æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

---

**ğŸ¤– AI æœåŠ¡æ•°æ®æ ¼å¼é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼** âœ¨

ç°åœ¨å¯ä»¥ï¼š
- âœ… æ­£å¸¸è¿›è¡Œ AI å¯¹æˆ˜
- âœ… ç©å®¶è½å­æ­£ç¡®æ˜¾ç¤º
- âœ… AI è‡ªåŠ¨è½å­æ­£ç¡®æ˜¾ç¤º
- âœ… ä¸å†å‡ºç°æ•°æ®æ ¼å¼é”™è¯¯

