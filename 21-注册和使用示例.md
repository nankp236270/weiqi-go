# 🎮 Weiqi-Go 注册和使用示例

**更新时间**: 2025年12月4日  
**状态**: ✅ 所有功能正常

---

## ✅ 问题已解决

### 1. CORS 跨域问题 ✅
**问题**: 前端无法访问后端 API，OPTIONS 请求返回 404  
**解决**: 添加 CORS 中间件，支持跨域请求  
**结果**: 前端可以正常调用后端 API

### 2. MongoDB 日志过多 ✅
**问题**: MongoDB 输出大量连接日志，难以定位错误  
**解决**: 配置 MongoDB 使用 `--quiet --logpath /dev/null`  
**结果**: MongoDB 日志已被禁用，后端日志更清晰

---

## 🚀 完整使用示例

### 1. 用户注册

#### 命令行方式
```bash
curl -X POST http://localhost:8080/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "player1",
    "email": "player1@example.com",
    "password": "password123"
  }'
```

#### 响应示例
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "451fd18b-887a-4bda-aaf0-2549cad38131",
    "username": "player1",
    "email": "player1@example.com",
    "created_at": "2025-12-04T03:02:56.785Z"
  }
}
```

#### 前端方式
在浏览器中访问 http://localhost:3000，点击"还没有账号？立即注册"，填写信息即可。

---

### 2. 用户登录

#### 命令行方式
```bash
curl -X POST http://localhost:8080/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "player1",
    "password": "password123"
  }'
```

#### 响应示例
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "451fd18b-887a-4bda-aaf0-2549cad38131",
    "username": "player1",
    "email": "player1@example.com",
    "created_at": "2025-12-04T03:02:56.785Z"
  }
}
```

**重要**: 保存返回的 `token`，后续请求需要使用！

---

### 3. 创建 AI 游戏

#### 命令行方式
```bash
# 使用登录时获得的 token
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

curl -X POST http://localhost:8080/v1/games \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "is_ai_game": true
  }'
```

#### 响应示例
```json
{
  "game_id": "67504a2e-1234-5678-9abc-def012345678"
}
```

---

### 4. 获取游戏状态

```bash
GAME_ID="67504a2e-1234-5678-9abc-def012345678"

curl -X GET http://localhost:8080/v1/games/$GAME_ID \
  -H "Authorization: Bearer $TOKEN"
```

#### 响应示例
```json
{
  "id": "67504a2e-1234-5678-9abc-def012345678",
  "board": {
    "size": 19,
    "grid": [[0,0,0,...], [0,0,0,...], ...]
  },
  "next_player": "Black",
  "passes": 0,
  "game_over": false,
  "captures_by_b": 0,
  "captures_by_w": 0,
  "player_black_id": "451fd18b-887a-4bda-aaf0-2549cad38131",
  "state": "playing",
  "is_ai_game": true
}
```

---

### 5. 落子

```bash
curl -X POST http://localhost:8080/v1/games/$GAME_ID/move \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "x": 3,
    "y": 3
  }'
```

#### 响应
返回更新后的游戏状态（格式同上）

---

### 6. AI 落子

```bash
curl -X POST http://localhost:8080/v1/games/$GAME_ID/ai-move \
  -H "Authorization: Bearer $TOKEN"
```

#### 响应
返回 AI 落子后的游戏状态

---

### 7. 虚手

```bash
curl -X POST http://localhost:8080/v1/games/$GAME_ID/pass \
  -H "Authorization: Bearer $TOKEN"
```

**注意**: 连续两次虚手将结束游戏

---

### 8. 查看我的游戏

```bash
curl -X GET http://localhost:8080/v1/games/my \
  -H "Authorization: Bearer $TOKEN"
```

#### 响应示例
```json
{
  "count": 2,
  "games": [
    {
      "id": "game-id-1",
      "state": "playing",
      "is_ai_game": true,
      ...
    },
    {
      "id": "game-id-2",
      "state": "finished",
      "is_ai_game": false,
      ...
    }
  ]
}
```

---

### 9. 查看等待中的游戏

```bash
curl -X GET http://localhost:8080/v1/games/waiting \
  -H "Authorization: Bearer $TOKEN"
```

---

### 10. 加入游戏

```bash
WAITING_GAME_ID="some-game-id"

curl -X POST http://localhost:8080/v1/games/$WAITING_GAME_ID/join \
  -H "Authorization: Bearer $TOKEN"
```

---

## 🎨 前端使用流程

### 1. 访问应用
打开浏览器访问: http://localhost:3000

### 2. 注册账号
- 点击"还没有账号？立即注册"
- 填写用户名、邮箱、密码
- 点击"注册"按钮

### 3. 登录系统
- 输入用户名和密码
- 点击"登录"按钮
- 自动跳转到游戏大厅

### 4. 创建游戏
在游戏大厅：
- 点击"创建 AI 对战"创建 AI 游戏
- 或点击"创建玩家对战"创建玩家游戏

### 5. 开始对弈
- 在棋盘上点击落子
- AI 游戏会自动触发 AI 落子
- 可以点击"虚手"跳过回合

### 6. 查看游戏
- "我的游戏"列表显示所有参与的游戏
- "等待中的游戏"显示可加入的游戏
- 点击游戏卡片进入游戏

---

## 📝 完整测试脚本

创建一个测试脚本 `test-complete.sh`：

```bash
#!/bin/bash

API_URL="http://localhost:8080"

echo "🎮 Weiqi-Go 完整测试"
echo "===================="

# 1. 注册用户
echo -e "\n1️⃣  注册用户..."
REGISTER_RESPONSE=$(curl -s -X POST $API_URL/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testplayer",
    "email": "test@example.com",
    "password": "password123"
  }')

TOKEN=$(echo $REGISTER_RESPONSE | grep -o '"token":"[^"]*' | cut -d'"' -f4)
echo "✅ 注册成功，Token: ${TOKEN:0:20}..."

# 2. 登录
echo -e "\n2️⃣  用户登录..."
LOGIN_RESPONSE=$(curl -s -X POST $API_URL/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testplayer",
    "password": "password123"
  }')
echo "✅ 登录成功"

# 3. 创建 AI 游戏
echo -e "\n3️⃣  创建 AI 游戏..."
CREATE_RESPONSE=$(curl -s -X POST $API_URL/v1/games \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_ai_game": true}')

GAME_ID=$(echo $CREATE_RESPONSE | grep -o '"game_id":"[^"]*' | cut -d'"' -f4)
echo "✅ 游戏创建成功，ID: $GAME_ID"

# 4. 落子
echo -e "\n4️⃣  黑棋落子 (3,3)..."
curl -s -X POST $API_URL/v1/games/$GAME_ID/move \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"x": 3, "y": 3}' > /dev/null
echo "✅ 落子成功"

# 5. AI 落子
echo -e "\n5️⃣  AI 落子..."
curl -s -X POST $API_URL/v1/games/$GAME_ID/ai-move \
  -H "Authorization: Bearer $TOKEN" > /dev/null
echo "✅ AI 落子成功"

# 6. 查看游戏状态
echo -e "\n6️⃣  查看游戏状态..."
GAME_STATE=$(curl -s -X GET $API_URL/v1/games/$GAME_ID \
  -H "Authorization: Bearer $TOKEN")
echo "✅ 游戏状态获取成功"

# 7. 查看我的游戏
echo -e "\n7️⃣  查看我的游戏..."
MY_GAMES=$(curl -s -X GET $API_URL/v1/games/my \
  -H "Authorization: Bearer $TOKEN")
GAME_COUNT=$(echo $MY_GAMES | grep -o '"count":[0-9]*' | cut -d':' -f2)
echo "✅ 我的游戏数量: $GAME_COUNT"

echo -e "\n🎉 所有测试通过！"
```

运行测试：
```bash
chmod +x test-complete.sh
./test-complete.sh
```

---

## 🔍 日志查看

### 查看后端日志
```bash
# 实时查看
docker logs weiqi-backend -f

# 查看最近 50 行
docker logs weiqi-backend --tail 50

# 只看错误
docker logs weiqi-backend 2>&1 | grep -i error
```

### 查看 AI 服务日志
```bash
docker logs weiqi-ai -f
```

### 查看所有服务日志
```bash
docker compose logs -f
```

---

## ⚠️ 常见问题

### 1. Token 过期
**症状**: 请求返回 401 Unauthorized  
**解决**: 重新登录获取新 Token

### 2. 游戏不存在
**症状**: 请求返回 404 Not Found  
**解决**: 检查 GAME_ID 是否正确

### 3. 不是你的回合
**症状**: 落子失败，提示"not your turn"  
**解决**: 等待对方落子或 AI 落子

### 4. 非法落子
**症状**: 落子失败，提示"invalid move"  
**解决**: 
- 检查位置是否已有棋子
- 检查是否违反自杀规则
- 检查是否违反 Ko 规则

---

## 📊 API 端点总览

| 方法 | 路径 | 说明 | 需要认证 |
|------|------|------|----------|
| POST | `/v1/auth/register` | 用户注册 | ❌ |
| POST | `/v1/auth/login` | 用户登录 | ❌ |
| GET | `/v1/auth/me` | 获取用户信息 | ✅ |
| POST | `/v1/games` | 创建游戏 | ✅ |
| GET | `/v1/games/:id` | 获取游戏状态 | ❌ |
| POST | `/v1/games/:id/move` | 落子 | ✅ |
| POST | `/v1/games/:id/pass` | 虚手 | ✅ |
| POST | `/v1/games/:id/ai-move` | AI 落子 | ✅ |
| POST | `/v1/games/:id/join` | 加入游戏 | ✅ |
| GET | `/v1/games/my` | 我的游戏 | ✅ |
| GET | `/v1/games/waiting` | 等待游戏 | ✅ |

---

## 🎉 总结

### 已修复的问题
- ✅ CORS 跨域问题
- ✅ MongoDB 日志过多
- ✅ 前端可以正常访问后端

### 当前状态
- ✅ 所有服务正常运行
- ✅ 注册和登录功能正常
- ✅ 游戏创建和对弈功能正常
- ✅ 日志简洁清晰

### 快速开始
1. 访问 http://localhost:3000
2. 注册账号
3. 创建 AI 游戏
4. 开始对弈！

---

**🎮 享受围棋对弈的乐趣吧！** 🎉


